{"version":3,"file":"5660.2b54aa680a48301089e4.js","mappings":"4sBA8Ce,MAAMA,UAAmBC,IAAAA,cAMpCC,WAAAA,CAAYC,GACRC,MAAMD,GAAOE,EAAA,kBAJqB,MAAIA,EAAA,oBACiC,CAAC,GAACA,EAAA,qBAqE7DC,IACZ,MAAMC,EAAkBC,KAAKL,MAAMM,SAASC,OAAQC,EAAAA,EAAAA,IAAmBH,KAAKL,MAAMM,SAASG,IAC3FN,EAAEO,iBACFC,OAAOC,SAASC,KAAOT,CAAe,IACzCF,EAAA,qBAEeY,IAAkB,IAAAC,EAAAC,EAAAC,EAAAC,EAC9B,MAAMC,EAAWL,EAAKM,wBAChBC,EAA+C,QAApCN,EAAyB,QAAzBC,EAAGX,KAAKiB,UAAUC,eAAO,IAAAP,OAAA,EAAtBA,EAAwBQ,iBAAS,IAAAT,EAAAA,EAAI,EACnDU,EAAiBJ,GAA4C,QAAjCJ,EAAmB,QAAnBC,EAAIb,KAAKqB,kBAAU,IAAAR,OAAA,EAAfA,EAAiBS,oBAAY,IAAAV,EAAAA,EAAI,GACvE,OACKE,EAASS,KAAOP,GAAeF,EAASS,KAAOH,GAC/CN,EAASU,QAAUR,GAAeF,EAASU,QAAUJ,GACrDN,EAASS,KAAOP,GAAeF,EAASU,QAAUJ,CAAe,IAEzEvB,EAAA,sBAEe4B,UACZ,MAAMC,EAAS1B,KAAK2B,aAAa,gBAADC,OAAiBC,IAAaX,QAC9D,IAAKQ,EAED,OAKJ,GAAIG,GA9HmB,IA8HqB7B,KAAK8B,aAAaJ,GAC1D,OAGJ,GAAI1B,KAAK+B,iBAAiBF,GACtB,OAGJ,MAAMpB,QAAaT,KAAKgC,SAAShC,KAAKiC,MAAMC,IAAML,GAC5CM,EAAUT,EAAOU,WAAW,MAC5BC,EAAW5B,EAAK6B,YAAY,CAACC,MAAOvC,KAAKL,MAAM4C,QACrDb,EAAOc,OAASH,EAASG,OACzBd,EAAOe,MAAQJ,EAASI,MAExB,MAAMC,EAAgB,CAClBC,cAAeR,EACfE,kBAGE5B,EAAKmC,OAAOF,GAAeG,QACjC7C,KAAK+B,iBAAiBF,IAAa,CAAI,IAC1ChC,EAAA,uBAEgB4B,UACb,IACI,MAAMS,QAAYY,EAAAA,GAAqB,CACnCC,IAAK/C,KAAKL,MAAMqD,QAChBC,SAASC,EAAAA,EAAAA,MAAe,iBACxBC,YAAY,IACbN,QACH7C,KAAKoD,eAAelB,EACxB,CAAE,MAAOmB,GACLrD,KAAKsD,oBAAoBD,EAC7B,KACHxD,EAAA,uBAEiBqC,IACdlC,KAAKuD,SAAS,CAACrB,MAAKsB,SAAUtB,EAAIsB,WAClC,IAAK,IAAIC,EAAI,EAAGA,EAAIvB,EAAIsB,SAAUC,IAC9BzD,KAAK2B,aAAa,gBAADC,OAAiB6B,IAAOhE,IAAAA,YAE7CO,KAAKuD,SAAS,CAACG,SAAS,EAAOC,SAAS,GAAM,IACjD9D,EAAA,4BAEsB+D,IACnBC,QAAQC,IAAI,+BAAiCF,GAC7C5D,KAAKuD,SAAS,CAACG,SAAS,EAAOC,SAAS,GAAO,IAClD9D,EAAA,iBAEU4B,MAAOS,EAAuBL,KACrC,GAAI7B,KAAKiC,MAAM8B,eAAelC,GAC1B,OAAO7B,KAAKiC,MAAM+B,SAASnC,GAG/B,MAAMpB,QAAayB,EAAI+B,QAAQpC,EAAY,GAErCmC,EAAWE,OAAOC,OAAO,CAAC,EAAGnE,KAAKiC,MAAM+B,UAC9CA,EAASnC,GAAapB,EAEtB,MAAMsD,EAAiBG,OAAOC,OAAO,CAAC,EAAGnE,KAAKiC,MAAM8B,gBAIpD,OAHAA,EAAelC,IAAa,EAC5B7B,KAAKuD,SAAS,CAACS,WAAUD,mBAElBtD,CAAI,IACdZ,EAAA,oBAEcuE,KAAS,KACpB,GAAIpE,KAAKiC,MAAM0B,QACX,IAAK,IAAIF,EAAI,EAAGA,EAAIzD,KAAKiC,MAAMuB,SAAUC,IACrCzD,KAAKqE,cAAcZ,EAE3B,GACD,MAlKCzD,KAAK+B,iBAAmB,CAAC,EACzB/B,KAAKiB,UAAYxB,IAAAA,YAEjBO,KAAKiC,MAAQ,CACTC,IAAK,KACL8B,SAAU,GACVD,eAAgB,CAAC,EACjBP,SAAU,EACVE,SAAS,EACTC,SAAS,EACTW,YAAa,GAErB,CAEAC,iBAAAA,GAEgC,IAAAC,EAD5BxE,KAAKyE,iBACDzE,KAAKiB,UAAUC,UACflB,KAAKqB,WAAarB,KAAKiB,UAAUC,QAAQwD,cAC1B,QAAfF,EAAAxE,KAAKqB,kBAAU,IAAAmD,GAAfA,EAAiBG,iBAAiB,SAAU3E,KAAK4E,cAEzD,CAEAC,oBAAAA,GACQ7E,KAAKqB,YACLrB,KAAKqB,WAAWyD,oBAAoB,SAAU9E,KAAK4E,aAE3D,CAEA,+BAAOG,CAAyBpF,EAAcsC,GAC1C,OAAItC,EAAMqD,UAAYf,EAAMqC,YACjB,CACHpC,IAAK,KACL8B,SAAU,CAAC,EACXD,eAAgB,CAAC,EACjBP,SAAU,EACVE,SAAS,EACTC,SAAS,EACTW,YAAa3E,EAAMqD,SAGpB,IACX,CAEAgC,kBAAAA,CAAmBC,EAAkBC,GAKjC,GAJIlF,KAAKL,MAAMqD,UAAYiC,EAAUjC,UACjChD,KAAKyE,iBACLzE,KAAK+B,iBAAmB,CAAC,GAEzB/B,KAAKL,MAAM4C,QAAU0C,EAAU1C,QAC/BvC,KAAK+B,iBAAmB,CAAC,EACrB/B,KAAKiC,MAAM0B,SACX,IAAK,IAAIF,EAAI,EAAGA,EAAIzD,KAAKiC,MAAMuB,SAAUC,IACrCzD,KAAKqE,cAAcZ,GAK/B,IAAKyB,EAAUvB,SAAW3D,KAAKiC,MAAM0B,QACjC,IAAK,IAAIF,EAAI,EAAGA,EAAIzD,KAAKiC,MAAMuB,SAAUC,IACrCzD,KAAKqE,cAAcZ,EAG/B,CAsGAb,MAAAA,GACI,GAAI5C,KAAKiC,MAAMyB,QACX,OACIjE,IAAAA,cAAA,OACI0F,IAAKnF,KAAKiB,UACVmE,UAAU,uBAEV3F,IAAAA,cAAC4F,EAAAA,EAAc,OAK3B,IAAKrF,KAAKiC,MAAM0B,QACZ,OACIlE,IAAAA,cAAC6F,EAAAA,EAAe,CACZrF,SAAUD,KAAKL,MAAMM,SACrB+C,QAAShD,KAAKL,MAAMqD,UAKhC,MAAMuC,EAAc,GACpB,IAAK,IAAI9B,EAAI,EAAGA,EAAIzD,KAAKiC,MAAMuB,SAAUC,IACrC8B,EAAYC,KACR/F,IAAAA,cAAA,UACI0F,IAAKnF,KAAK2B,aAAa,gBAADC,OAAiB6B,IACvCgC,IAAK,mBAAqBhC,KAI9BA,EAAIzD,KAAKiC,MAAMuB,SAAW,GAAKxD,KAAKiC,MAAMuB,SAAW,GACrD+B,EAAYC,KACR/F,IAAAA,cAAA,OACIgG,IAAK,mBAAqBhC,EAC1B2B,UAAU,wBAM1B,OACI3F,IAAAA,cAAA,OACI0F,IAAKnF,KAAKiB,UACVmE,UAAU,YACVM,QAAS1F,KAAKL,MAAMgG,eAEnBJ,EAGb,EACH1F,EA/NoBL,EAAU,aAf3BwD,QAAO4C,IAAAA,OAAAC,WACPtD,MAAKqD,IAAAA,OAAAC,WACLF,cAAaC,IAAAA,KAAAC,Y","sources":["webpack://mattermost-webapp/./src/components/pdf_preview.tsx"],"sourcesContent":["// Copyright (c) 2015-present Mattermost, Inc. All Rights Reserved.\r\n// See LICENSE.txt for license information.\r\n\r\nimport debounce from 'lodash/debounce';\r\nimport type {PDFDocumentProxy, PDFPageProxy} from 'pdfjs-dist';\r\nimport * as pdfjsLib from 'pdfjs-dist/legacy/build/pdf.mjs';\r\nimport 'pdfjs-dist/build/pdf.worker.min.mjs';\r\nimport type {RenderParameters} from 'pdfjs-dist/types/src/display/api';\r\nimport React from 'react';\r\n\r\nimport type {FileInfo} from '@mattermost/types/files';\r\n\r\nimport {getFileDownloadUrl} from 'mattermost-redux/utils/file_utils';\r\n\r\nimport FileInfoPreview from 'components/file_info_preview';\r\nimport LoadingSpinner from 'components/widgets/loading/loading_spinner';\r\n\r\nimport {getSiteURL} from 'utils/url';\r\n\r\nconst INITIAL_RENDERED_PAGES = 3;\r\n\r\nexport type Props = {\r\n\r\n    /**\r\n        * Compare file types\r\n    */\r\n    fileInfo: FileInfo;\r\n\r\n    /**\r\n        *  URL of pdf file to output and compare to update props url\r\n    */\r\n    fileUrl: string;\r\n    scale: number;\r\n    handleBgClose: (e: React.MouseEvent<Element, MouseEvent>) => void;\r\n}\r\n\r\ntype State = {\r\n    pdf: PDFDocumentProxy | null;\r\n    pdfPages: Record<number, PDFPageProxy>;\r\n    pdfPagesLoaded: Record<number, boolean>;\r\n    numPages: number;\r\n    loading: boolean;\r\n    success: boolean;\r\n    prevFileUrl: string;\r\n}\r\n\r\nexport default class PDFPreview extends React.PureComponent<Props, State> {\r\n    public pdfPagesRendered: Record<number, boolean>;\r\n    public container: React.RefObject<HTMLDivElement>;\r\n    public parentNode: HTMLElement|null = null;\r\n    public pdfCanvasRef: {[key: string]: React.RefObject<HTMLCanvasElement>} = {};\r\n\r\n    constructor(props: Props) {\r\n        super(props);\r\n\r\n        this.pdfPagesRendered = {};\r\n        this.container = React.createRef();\r\n\r\n        this.state = {\r\n            pdf: null,\r\n            pdfPages: [],\r\n            pdfPagesLoaded: {},\r\n            numPages: 0,\r\n            loading: true,\r\n            success: false,\r\n            prevFileUrl: '',\r\n        };\r\n    }\r\n\r\n    componentDidMount() {\r\n        this.getPdfDocument();\r\n        if (this.container.current) {\r\n            this.parentNode = this.container.current.parentElement;\r\n            this.parentNode?.addEventListener('scroll', this.handleScroll);\r\n        }\r\n    }\r\n\r\n    componentWillUnmount() {\r\n        if (this.parentNode) {\r\n            this.parentNode.removeEventListener('scroll', this.handleScroll);\r\n        }\r\n    }\r\n\r\n    static getDerivedStateFromProps(props: Props, state: State) {\r\n        if (props.fileUrl !== state.prevFileUrl) {\r\n            return {\r\n                pdf: null,\r\n                pdfPages: {},\r\n                pdfPagesLoaded: {},\r\n                numPages: 0,\r\n                loading: true,\r\n                success: false,\r\n                prevFileUrl: props.fileUrl,\r\n            };\r\n        }\r\n        return null;\r\n    }\r\n\r\n    componentDidUpdate(prevProps: Props, prevState: State) {\r\n        if (this.props.fileUrl !== prevProps.fileUrl) {\r\n            this.getPdfDocument();\r\n            this.pdfPagesRendered = {};\r\n        }\r\n        if (this.props.scale !== prevProps.scale) {\r\n            this.pdfPagesRendered = {};\r\n            if (this.state.success) {\r\n                for (let i = 0; i < this.state.numPages; i++) {\r\n                    this.renderPDFPage(i);\r\n                }\r\n            }\r\n        }\r\n\r\n        if (!prevState.success && this.state.success) {\r\n            for (let i = 0; i < this.state.numPages; i++) {\r\n                this.renderPDFPage(i);\r\n            }\r\n        }\r\n    }\r\n\r\n    downloadFile = (e: React.FormEvent) => {\r\n        const fileDownloadUrl = this.props.fileInfo.link || getFileDownloadUrl(this.props.fileInfo.id);\r\n        e.preventDefault();\r\n        window.location.href = fileDownloadUrl;\r\n    };\r\n\r\n    isInViewport = (page: Element) => {\r\n        const bounding = page.getBoundingClientRect();\r\n        const viewportTop = this.container.current?.scrollTop ?? 0;\r\n        const viewportBottom = viewportTop + (this.parentNode?.clientHeight ?? 0);\r\n        return (\r\n            (bounding.top >= viewportTop && bounding.top <= viewportBottom) ||\r\n            (bounding.bottom >= viewportTop && bounding.bottom <= viewportBottom) ||\r\n            (bounding.top <= viewportTop && bounding.bottom >= viewportBottom)\r\n        );\r\n    };\r\n\r\n    renderPDFPage = async (pageIndex: number) => {\r\n        const canvas = this.pdfCanvasRef[`pdfCanvasRef-${pageIndex}`].current;\r\n        if (!canvas) {\r\n            // Refs are undefined when testing\r\n            return;\r\n        }\r\n\r\n        // Always render the first INITIAL_RENDERED_PAGES pages to avoid\r\n        // problems detecting isInViewport during the open animation\r\n        if (pageIndex >= INITIAL_RENDERED_PAGES && !this.isInViewport(canvas)) {\r\n            return;\r\n        }\r\n\r\n        if (this.pdfPagesRendered[pageIndex]) {\r\n            return;\r\n        }\r\n\r\n        const page = await this.loadPage(this.state.pdf!, pageIndex);\r\n        const context = canvas.getContext('2d');\r\n        const viewport = page.getViewport({scale: this.props.scale});\r\n        canvas.height = viewport.height;\r\n        canvas.width = viewport.width;\r\n\r\n        const renderContext = {\r\n            canvasContext: context as object,\r\n            viewport,\r\n        } as RenderParameters;\r\n\r\n        await page.render(renderContext).promise;\r\n        this.pdfPagesRendered[pageIndex] = true;\r\n    };\r\n\r\n    getPdfDocument = async () => {\r\n        try {\r\n            const pdf = await pdfjsLib.getDocument({\r\n                url: this.props.fileUrl,\r\n                cMapUrl: getSiteURL() + '/static/cmaps/',\r\n                cMapPacked: true,\r\n            }).promise;\r\n            this.onDocumentLoad(pdf);\r\n        } catch (err) {\r\n            this.onDocumentLoadError(err);\r\n        }\r\n    };\r\n\r\n    onDocumentLoad = (pdf: PDFDocumentProxy) => {\r\n        this.setState({pdf, numPages: pdf.numPages});\r\n        for (let i = 0; i < pdf.numPages; i++) {\r\n            this.pdfCanvasRef[`pdfCanvasRef-${i}`] = React.createRef();\r\n        }\r\n        this.setState({loading: false, success: true});\r\n    };\r\n\r\n    onDocumentLoadError = (reason: string) => {\r\n        console.log('Unable to load PDF preview: ' + reason); //eslint-disable-line no-console\r\n        this.setState({loading: false, success: false});\r\n    };\r\n\r\n    loadPage = async (pdf: PDFDocumentProxy, pageIndex: number) => {\r\n        if (this.state.pdfPagesLoaded[pageIndex]) {\r\n            return this.state.pdfPages[pageIndex];\r\n        }\r\n\r\n        const page = await pdf.getPage(pageIndex + 1);\r\n\r\n        const pdfPages = Object.assign({}, this.state.pdfPages);\r\n        pdfPages[pageIndex] = page;\r\n\r\n        const pdfPagesLoaded = Object.assign({}, this.state.pdfPagesLoaded);\r\n        pdfPagesLoaded[pageIndex] = true;\r\n        this.setState({pdfPages, pdfPagesLoaded});\r\n\r\n        return page;\r\n    };\r\n\r\n    handleScroll = debounce(() => {\r\n        if (this.state.success) {\r\n            for (let i = 0; i < this.state.numPages; i++) {\r\n                this.renderPDFPage(i);\r\n            }\r\n        }\r\n    }, 100);\r\n\r\n    render() {\r\n        if (this.state.loading) {\r\n            return (\r\n                <div\r\n                    ref={this.container}\r\n                    className='view-image__loading'\r\n                >\r\n                    <LoadingSpinner/>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        if (!this.state.success) {\r\n            return (\r\n                <FileInfoPreview\r\n                    fileInfo={this.props.fileInfo}\r\n                    fileUrl={this.props.fileUrl}\r\n                />\r\n            );\r\n        }\r\n\r\n        const pdfCanvases = [];\r\n        for (let i = 0; i < this.state.numPages; i++) {\r\n            pdfCanvases.push(\r\n                <canvas\r\n                    ref={this.pdfCanvasRef[`pdfCanvasRef-${i}`]}\r\n                    key={'previewpdfcanvas' + i}\r\n                />,\r\n            );\r\n\r\n            if (i < this.state.numPages - 1 && this.state.numPages > 1) {\r\n                pdfCanvases.push(\r\n                    <div\r\n                        key={'previewpdfspacer' + i}\r\n                        className='pdf-preview-spacer'\r\n                    />,\r\n                );\r\n            }\r\n        }\r\n\r\n        return (\r\n            <div\r\n                ref={this.container}\r\n                className='post-code'\r\n                onClick={this.props.handleBgClose}\r\n            >\r\n                {pdfCanvases}\r\n            </div>\r\n        );\r\n    }\r\n}\r\n"],"names":["PDFPreview","React","constructor","props","super","_defineProperty","e","fileDownloadUrl","this","fileInfo","link","getFileDownloadUrl","id","preventDefault","window","location","href","page","_this$container$curre","_this$container$curre2","_this$parentNode$clie","_this$parentNode","bounding","getBoundingClientRect","viewportTop","container","current","scrollTop","viewportBottom","parentNode","clientHeight","top","bottom","async","canvas","pdfCanvasRef","concat","pageIndex","isInViewport","pdfPagesRendered","loadPage","state","pdf","context","getContext","viewport","getViewport","scale","height","width","renderContext","canvasContext","render","promise","pdfjsLib","url","fileUrl","cMapUrl","getSiteURL","cMapPacked","onDocumentLoad","err","onDocumentLoadError","setState","numPages","i","loading","success","reason","console","log","pdfPagesLoaded","pdfPages","getPage","Object","assign","debounce","renderPDFPage","prevFileUrl","componentDidMount","_this$parentNode2","getPdfDocument","parentElement","addEventListener","handleScroll","componentWillUnmount","removeEventListener","getDerivedStateFromProps","componentDidUpdate","prevProps","prevState","ref","className","LoadingSpinner","FileInfoPreview","pdfCanvases","push","key","onClick","handleBgClose","_pt","isRequired"],"sourceRoot":""}